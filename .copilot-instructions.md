# PlastiGest Backend - Instrucciones para GitHub Copilot

## 🏗️ Arquitectura del Backend Laravel

### Sistema Base

-   **Framework**: Laravel 11
-   **Base de Datos**: MySQL (multi-tenant por compañía)
-   **Autenticación**: Laravel Sanctum
-   **Patrón**: CrudController extendible para todos los módulos
-   **API**: RESTful con Resources para transformación de datos

---

## 🎯 Comandos Obligatorios

### 1. **Generar CRUD Completo**

```bash
# SIEMPRE usar este comando para nuevos módulos
php artisan make:crud [ModelName]                # Ejemplo: Product
php artisan make:crud [Namespace/ModelName]      # Ejemplo: Admin/Worker
```

**Qué genera automáticamente:**

-   ✅ Model en `/app/Models/[Namespace/]`
-   ✅ Controller en `/app/Http/Controllers/[Namespace/]`
-   ✅ Resource en `/app/Http/Resources/[Namespace/]`
-   ✅ Extiende CrudController con métodos CRUD completos

### 2. **Crear Migración**

```bash
php artisan make:migration create_[table_name]_table
```

### 3. **Ejecutar Migraciones**

```bash
php artisan migrate
```

---

## 📋 Estructura Obligatoria por Módulo

### 1. **Modelo** - Siempre configurar:

```php
class Worker extends Model
{
    // ✅ OBLIGATORIO: Definir campos fillable
    protected $fillable = [
        'company_id',      // Siempre incluir para multi-tenant
        'field1',
        'field2',
        'is_active',       // Siempre incluir para soft-delete lógico
    ];

    // ✅ OBLIGATORIO: Fechas
    protected $dates = [
        'created_at',
        'updated_at',
    ];

    // ✅ OBLIGATORIO: Relación con Company (si aplica)
    public function company()
    {
        return $this->belongsTo(Company::class);
    }

    // ✅ Otras relaciones según necesidad
}
```

### 2. **Controller** - Siempre extender CrudController:

```php
class WorkerController extends CrudController
{
    // ✅ OBLIGATORIO: Definir resource y modelo
    protected string $resource = WorkerResource::class;
    protected string $model = Worker::class;

    // ✅ OBLIGATORIO: Relaciones para index (lista)
    protected function indexRelations(): array
    {
        return [
            'company',  // Siempre cargar company si existe relación
            // ... otras relaciones
        ];
    }

    // ✅ OBLIGATORIO: Relaciones para show/edit
    protected function getShowRelations(): array
    {
        return [
            'company',
            // ... otras relaciones
        ];
    }

    // ✅ OBLIGATORIO: Validación para crear
    protected function validateStoreData(Request $request): array
    {
        return $request->validate([
            'company_id' => 'required|exists:companies,id',  // Multi-tenant
            // ... otros campos con validaciones
            'is_active' => 'boolean',
        ]);
    }

    // ✅ OBLIGATORIO: Validación para actualizar
    protected function validateUpdateData(Request $request, Model $model): array
    {
        return $request->validate([
            'company_id' => 'required|exists:companies,id',
            // ... otros campos (unique con excepción del ID actual)
            'is_active' => 'boolean',
        ]);
    }

    // ✅ OPCIONAL: Filtros personalizados
    protected function handleQuery($query, array $params)
    {
        // Filtros específicos del modelo
        if (isset($params['company_id'])) {
            $query->where('company_id', $params['company_id']);
        }
    }
}
```

### 3. **Resource** - Siempre extender Resources:

```php
class WorkerResource extends Resources
{
    // ✅ OBLIGATORIO: Implementar método formatter
    public function formatter(Model $resource, array $data, array $context): array
    {
        $editing = $this->getContext('editing', false);

        $item = [
            'id' => $resource->id,
            // ✅ Campos básicos del modelo
            'field1' => $resource->field1,
            'field2' => $resource->field2,
            'is_active' => $resource->is_active ?? true,
        ];

        // ✅ OBLIGATORIO: Incluir relaciones cargadas
        if ($resource->relationLoaded('company')) {
            $item['company'] = [
                'id' => $resource->company?->id,
                'name' => $resource->company?->name,
            ];
        }

        // ✅ OBLIGATORIO: Datos adicionales para edición
        if ($editing) {
            $item['created_at'] = $resource->created_at?->toISOString();
            $item['updated_at'] = $resource->updated_at?->toISOString();
        }

        return $item;
    }
}
```

---

## 🛣️ Rutas API - Patrón Obligatorio

### Ubicación: `/routes/api.php`

```php
use App\Http\Controllers\Admin\WorkerController;
use App\Http\Controllers\ProductController;

Route::middleware('auth:sanctum')->group(function () {
    Route::prefix('auth')->group(function () {

        // ✅ Admin routes (users, companies, locations, etc.)
        Route::prefix('admin')->group(function () {
            Route::apiResource('companies', CompanyController::class);
            Route::apiResource('locations', LocationController::class);
            Route::apiResource('workers', WorkerController::class);
            Route::apiResource('users', UserController::class);
            Route::apiResource('roles', RolesController::class);
            // ✅ SIEMPRE agregar aquí los CRUDs Admin/
        });

        // ✅ Catalog routes (products, categories, etc.)
        Route::prefix('catalog')->group(function () {
            Route::apiResource('products', ProductController::class);
            Route::apiResource('categories', CategoryController::class);
            Route::apiResource('units', UnitController::class);
            Route::apiResource('customers', CustomerController::class);
            Route::apiResource('suppliers', SupplierController::class);
            // ✅ SIEMPRE agregar aquí los CRUDs de catálogos
        });

        // ✅ Operations routes (purchases, sales, movements)
        Route::prefix('operations')->group(function () {
            Route::apiResource('purchases', PurchaseOrderController::class);
            Route::apiResource('sales', SalesOrderController::class);
            Route::apiResource('movements', MovementController::class);
            // ✅ SIEMPRE agregar aquí los CRUDs de operaciones
        });
    });
});
```

---

## 🗄️ Migraciones - Patrón Estándar

### Estructura Base para Todas las Tablas:

```php
Schema::create('workers', function (Blueprint $table) {
    $table->id();

    // ✅ OBLIGATORIO: company_id para multi-tenant (si aplica)
    $table->foreignId('company_id')->constrained('companies')->onDelete('cascade');

    // ✅ Campos específicos del modelo
    $table->string('field1');
    $table->string('field2')->nullable();

    // ✅ OBLIGATORIO: is_active para soft delete lógico
    $table->boolean('is_active')->default(true);

    // ✅ OBLIGATORIO: timestamps
    $table->timestamps();

    // ✅ OBLIGATORIO: Índices para performance
    $table->index(['company_id', 'is_active']);
});
```

### Relaciones Comunes:

```php
// Muchos a uno con Company
$table->foreignId('company_id')->constrained('companies')->onDelete('cascade');

// Muchos a uno con User
$table->foreignId('user_id')->constrained('users')->onDelete('cascade');

// Muchos a uno con Location
$table->foreignId('location_id')->nullable()->constrained('locations')->onDelete('set null');

// Muchos a muchos (tabla pivot)
Schema::create('product_suppliers', function (Blueprint $table) {
    $table->id();
    $table->foreignId('product_id')->constrained()->onDelete('cascade');
    $table->foreignId('supplier_id')->constrained()->onDelete('cascade');
    $table->timestamps();

    $table->unique(['product_id', 'supplier_id']);
});
```

---

## 📦 Módulos Prioritarios para Implementar

### 🏛️ **Admin Namespace** - `Admin/`

```bash
php artisan make:crud Admin/Worker        # ⚠️ CRÍTICO
php artisan make:migration create_workers_table

php artisan make:crud Admin/Customer
php artisan make:migration create_customers_table

php artisan make:crud Admin/Supplier
php artisan make:migration create_suppliers_table
```

### 📋 **Catálogos** - Sin namespace

```bash
php artisan make:crud Product
php artisan make:migration create_products_table

php artisan make:crud Category
php artisan make:migration create_categories_table

php artisan make:crud Unit
php artisan make:migration create_units_table
```

### 🔄 **Operaciones** - `Operations/`

```bash
php artisan make:crud Operations/PurchaseOrder
php artisan make:migration create_purchase_orders_table

php artisan make:crud Operations/SalesOrder
php artisan make:migration create_sales_orders_table

php artisan make:crud Operations/Movement
php artisan make:migration create_movements_table
```

---

## 🔥 CrudController - Métodos Disponibles

El `CrudController` base proporciona automáticamente:

### Endpoints API Estándar:

-   `GET /api/auth/admin/workers` - Lista (con paginación opcional)
-   `POST /api/auth/admin/workers` - Crear nuevo
-   `GET /api/auth/admin/workers/{id}` - Ver por ID
-   `PUT /api/auth/admin/workers/{id}` - Actualizar
-   `DELETE /api/auth/admin/workers/{id}` - Eliminar

### Parámetros de Query Soportados:

-   `?paginated=true` - Activar paginación
-   `?per_page=10` - Items por página
-   `?search=term` - Búsqueda general
-   `?company_id=1` - Filtrar por compañía

### Métodos Heredados Automáticamente:

```php
// En cualquier Controller que extienda CrudController:
public function index(Request $request)     // Lista con filtros
public function store(Request $request)     // Crear
public function show($id)                   // Ver por ID
public function update(Request $request, $id) // Actualizar
public function destroy($id)                // Eliminar
```

---

## 🚨 Reglas Críticas

### ✅ **SIEMPRE hacer:**

1. Usar `php artisan make:crud` para generar módulos
2. Crear migración después del CRUD
3. Configurar `$fillable` en el modelo
4. Incluir `company_id` para multi-tenant
5. Incluir `is_active` para soft delete lógico
6. Implementar validaciones en el controller
7. Cargar relaciones necesarias
8. Registrar ruta API en el grupo correcto
9. Probar endpoints antes de continuar

### ❌ **NUNCA hacer:**

1. Crear controllers/models/resources manualmente
2. Olvidar registrar la ruta API
3. Omitir validaciones en store/update
4. Dejar modelos sin relaciones configuradas
5. Usar eliminación física (usar `is_active` en su lugar)

---

## 🧪 Testing de APIs

### Comando para probar endpoints:

```bash
# Obtener token de autenticación primero
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"password"}'

# Usar token en requests subsecuentes
export TOKEN="your-token-here"

# Probar CRUD completo
curl -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers
curl -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"company_id":1,"field1":"value"}' http://localhost/api/auth/admin/workers
curl -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers/1
curl -X PUT -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"field1":"updated"}' http://localhost/api/auth/admin/workers/1
curl -X DELETE -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers/1
```

Este patrón garantiza consistencia total en el backend y facilita la integración con el frontend React Native.

---

## 🎯 Ejemplo Exitoso: Workers CRUD

### Referencia Completa Funcionando

Ver: `/docs/WORKERS_CRUD_EXAMPLE.md` para implementación completa y probada.

**Estado**: ✅ **TOTALMENTE FUNCIONAL**

-   API probada con todos los endpoints
-   Validaciones funcionando correctamente
-   Relaciones cargando apropiadamente
-   Filtros y paginación operativos
-   Documentación completa con ejemplos reales

### Comando Usado:

```bash
php artisan make:crud Admin/Worker
php artisan make:migration create_workers_table
php artisan migrate
```

### API Endpoints Probados:

-   ✅ `POST /api/auth/admin/workers` - Crear (201 Created)
-   ✅ `GET /api/auth/admin/workers` - Listar (200 OK)
-   ✅ `GET /api/auth/admin/workers/{id}` - Ver (200 OK)
-   ✅ `PUT /api/auth/admin/workers/{id}` - Actualizar
-   ✅ `DELETE /api/auth/admin/workers/{id}` - Eliminar

**Este ejemplo debe ser la referencia para todos los CRUDs futuros.**
