# PlastiGest Backend - Instrucciones para GitHub Copilot

## üèóÔ∏è Arquitectura del Backend Laravel

### Sistema Base

-   **Framework**: Laravel 11
-   **Base de Datos**: MySQL (multi-tenant por compa√±√≠a)
-   **Autenticaci√≥n**: Laravel Sanctum
-   **Patr√≥n**: CrudController extendible para todos los m√≥dulos
-   **API**: RESTful con Resources para transformaci√≥n de datos

---

## üéØ Comandos Obligatorios

### 1. **Generar CRUD Completo**

```bash
# SIEMPRE usar este comando para nuevos m√≥dulos
php artisan make:crud [ModelName]                # Ejemplo: Product
php artisan make:crud [Namespace/ModelName]      # Ejemplo: Admin/Worker
```

**Qu√© genera autom√°ticamente:**

-   ‚úÖ Model en `/app/Models/[Namespace/]`
-   ‚úÖ Controller en `/app/Http/Controllers/[Namespace/]`
-   ‚úÖ Resource en `/app/Http/Resources/[Namespace/]`
-   ‚úÖ Extiende CrudController con m√©todos CRUD completos

### 2. **Crear Migraci√≥n**

```bash
php artisan make:migration create_[table_name]_table
```

### 3. **Ejecutar Migraciones**

```bash
php artisan migrate
```

---

## üìã Estructura Obligatoria por M√≥dulo

### 1. **Modelo** - Siempre configurar:

```php
class Worker extends Model
{
    // ‚úÖ OBLIGATORIO: Definir campos fillable
    protected $fillable = [
        'company_id',      // Siempre incluir para multi-tenant
        'field1',
        'field2',
        'is_active',       // Siempre incluir para soft-delete l√≥gico
    ];

    // ‚úÖ OBLIGATORIO: Fechas
    protected $dates = [
        'created_at',
        'updated_at',
    ];

    // ‚úÖ OBLIGATORIO: Relaci√≥n con Company (si aplica)
    public function company()
    {
        return $this->belongsTo(Company::class);
    }

    // ‚úÖ Otras relaciones seg√∫n necesidad
}
```

### 2. **Controller** - Siempre extender CrudController:

```php
class WorkerController extends CrudController
{
    // ‚úÖ OBLIGATORIO: Definir resource y modelo
    protected string $resource = WorkerResource::class;
    protected string $model = Worker::class;

    // ‚úÖ OBLIGATORIO: Relaciones para index (lista)
    protected function indexRelations(): array
    {
        return [
            'company',  // Siempre cargar company si existe relaci√≥n
            // ... otras relaciones
        ];
    }

    // ‚úÖ OBLIGATORIO: Relaciones para show/edit
    protected function getShowRelations(): array
    {
        return [
            'company',
            // ... otras relaciones
        ];
    }

    // ‚úÖ OBLIGATORIO: Validaci√≥n para crear
    protected function validateStoreData(Request $request): array
    {
        return $request->validate([
            'company_id' => 'required|exists:companies,id',  // Multi-tenant
            // ... otros campos con validaciones
            'is_active' => 'boolean',
        ]);
    }

    // ‚úÖ OBLIGATORIO: Validaci√≥n para actualizar
    protected function validateUpdateData(Request $request, Model $model): array
    {
        return $request->validate([
            'company_id' => 'required|exists:companies,id',
            // ... otros campos (unique con excepci√≥n del ID actual)
            'is_active' => 'boolean',
        ]);
    }

    // ‚úÖ OPCIONAL: Filtros personalizados
    protected function handleQuery($query, array $params)
    {
        // Filtros espec√≠ficos del modelo
        if (isset($params['company_id'])) {
            $query->where('company_id', $params['company_id']);
        }
    }
}
```

### 3. **Resource** - Siempre extender Resources:

```php
class WorkerResource extends Resources
{
    // ‚úÖ OBLIGATORIO: Implementar m√©todo formatter
    public function formatter(Model $resource, array $data, array $context): array
    {
        $editing = $this->getContext('editing', false);

        $item = [
            'id' => $resource->id,
            // ‚úÖ Campos b√°sicos del modelo
            'field1' => $resource->field1,
            'field2' => $resource->field2,
            'is_active' => $resource->is_active ?? true,
        ];

        // ‚úÖ OBLIGATORIO: Incluir relaciones cargadas
        if ($resource->relationLoaded('company')) {
            $item['company'] = [
                'id' => $resource->company?->id,
                'name' => $resource->company?->name,
            ];
        }

        // ‚úÖ OBLIGATORIO: Datos adicionales para edici√≥n
        if ($editing) {
            $item['created_at'] = $resource->created_at?->toISOString();
            $item['updated_at'] = $resource->updated_at?->toISOString();
        }

        return $item;
    }
}
```

---

## üõ£Ô∏è Rutas API - Patr√≥n Obligatorio

### Ubicaci√≥n: `/routes/api.php`

```php
use App\Http\Controllers\Admin\WorkerController;
use App\Http\Controllers\ProductController;

Route::middleware('auth:sanctum')->group(function () {
    Route::prefix('auth')->group(function () {

        // ‚úÖ Admin routes (users, companies, locations, etc.)
        Route::prefix('admin')->group(function () {
            Route::apiResource('companies', CompanyController::class);
            Route::apiResource('locations', LocationController::class);
            Route::apiResource('workers', WorkerController::class);
            Route::apiResource('users', UserController::class);
            Route::apiResource('roles', RolesController::class);
            // ‚úÖ SIEMPRE agregar aqu√≠ los CRUDs Admin/
        });

        // ‚úÖ Catalog routes (products, categories, etc.)
        Route::prefix('catalog')->group(function () {
            Route::apiResource('products', ProductController::class);
            Route::apiResource('categories', CategoryController::class);
            Route::apiResource('units', UnitController::class);
            Route::apiResource('customers', CustomerController::class);
            Route::apiResource('suppliers', SupplierController::class);
            // ‚úÖ SIEMPRE agregar aqu√≠ los CRUDs de cat√°logos
        });

        // ‚úÖ Operations routes (purchases, sales, movements)
        Route::prefix('operations')->group(function () {
            Route::apiResource('purchases', PurchaseOrderController::class);
            Route::apiResource('sales', SalesOrderController::class);
            Route::apiResource('movements', MovementController::class);
            // ‚úÖ SIEMPRE agregar aqu√≠ los CRUDs de operaciones
        });
    });
});
```

---

## üóÑÔ∏è Migraciones - Patr√≥n Est√°ndar

### Estructura Base para Todas las Tablas:

```php
Schema::create('workers', function (Blueprint $table) {
    $table->id();

    // ‚úÖ OBLIGATORIO: company_id para multi-tenant (si aplica)
    $table->foreignId('company_id')->constrained('companies')->onDelete('cascade');

    // ‚úÖ Campos espec√≠ficos del modelo
    $table->string('field1');
    $table->string('field2')->nullable();

    // ‚úÖ OBLIGATORIO: is_active para soft delete l√≥gico
    $table->boolean('is_active')->default(true);

    // ‚úÖ OBLIGATORIO: timestamps
    $table->timestamps();

    // ‚úÖ OBLIGATORIO: √çndices para performance
    $table->index(['company_id', 'is_active']);
});
```

### Relaciones Comunes:

```php
// Muchos a uno con Company
$table->foreignId('company_id')->constrained('companies')->onDelete('cascade');

// Muchos a uno con User
$table->foreignId('user_id')->constrained('users')->onDelete('cascade');

// Muchos a uno con Location
$table->foreignId('location_id')->nullable()->constrained('locations')->onDelete('set null');

// Muchos a muchos (tabla pivot)
Schema::create('product_suppliers', function (Blueprint $table) {
    $table->id();
    $table->foreignId('product_id')->constrained()->onDelete('cascade');
    $table->foreignId('supplier_id')->constrained()->onDelete('cascade');
    $table->timestamps();

    $table->unique(['product_id', 'supplier_id']);
});
```

---

## üì¶ M√≥dulos Prioritarios para Implementar

### üèõÔ∏è **Admin Namespace** - `Admin/`

```bash
php artisan make:crud Admin/Worker        # ‚ö†Ô∏è CR√çTICO
php artisan make:migration create_workers_table

php artisan make:crud Admin/Customer
php artisan make:migration create_customers_table

php artisan make:crud Admin/Supplier
php artisan make:migration create_suppliers_table
```

### üìã **Cat√°logos** - Sin namespace

```bash
php artisan make:crud Product
php artisan make:migration create_products_table

php artisan make:crud Category
php artisan make:migration create_categories_table

php artisan make:crud Unit
php artisan make:migration create_units_table
```

### üîÑ **Operaciones** - `Operations/`

```bash
php artisan make:crud Operations/PurchaseOrder
php artisan make:migration create_purchase_orders_table

php artisan make:crud Operations/SalesOrder
php artisan make:migration create_sales_orders_table

php artisan make:crud Operations/Movement
php artisan make:migration create_movements_table
```

---

## üî• CrudController - M√©todos Disponibles

El `CrudController` base proporciona autom√°ticamente:

### Endpoints API Est√°ndar:

-   `GET /api/auth/admin/workers` - Lista (con paginaci√≥n opcional)
-   `POST /api/auth/admin/workers` - Crear nuevo
-   `GET /api/auth/admin/workers/{id}` - Ver por ID
-   `PUT /api/auth/admin/workers/{id}` - Actualizar
-   `DELETE /api/auth/admin/workers/{id}` - Eliminar

### Par√°metros de Query Soportados:

-   `?paginated=true` - Activar paginaci√≥n
-   `?per_page=10` - Items por p√°gina
-   `?search=term` - B√∫squeda general
-   `?company_id=1` - Filtrar por compa√±√≠a

### M√©todos Heredados Autom√°ticamente:

```php
// En cualquier Controller que extienda CrudController:
public function index(Request $request)     // Lista con filtros
public function store(Request $request)     // Crear
public function show($id)                   // Ver por ID
public function update(Request $request, $id) // Actualizar
public function destroy($id)                // Eliminar
```

---

## üö® Reglas Cr√≠ticas

### ‚úÖ **SIEMPRE hacer:**

1. Usar `php artisan make:crud` para generar m√≥dulos
2. Crear migraci√≥n despu√©s del CRUD
3. Configurar `$fillable` en el modelo
4. Incluir `company_id` para multi-tenant
5. Incluir `is_active` para soft delete l√≥gico
6. Implementar validaciones en el controller
7. Cargar relaciones necesarias
8. Registrar ruta API en el grupo correcto
9. Probar endpoints antes de continuar

### ‚ùå **NUNCA hacer:**

1. Crear controllers/models/resources manualmente
2. Olvidar registrar la ruta API
3. Omitir validaciones en store/update
4. Dejar modelos sin relaciones configuradas
5. Usar eliminaci√≥n f√≠sica (usar `is_active` en su lugar)

---

## üß™ Testing de APIs

### Comando para probar endpoints:

```bash
# Obtener token de autenticaci√≥n primero
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"password"}'

# Usar token en requests subsecuentes
export TOKEN="your-token-here"

# Probar CRUD completo
curl -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers
curl -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"company_id":1,"field1":"value"}' http://localhost/api/auth/admin/workers
curl -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers/1
curl -X PUT -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"field1":"updated"}' http://localhost/api/auth/admin/workers/1
curl -X DELETE -H "Authorization: Bearer $TOKEN" http://localhost/api/auth/admin/workers/1
```

Este patr√≥n garantiza consistencia total en el backend y facilita la integraci√≥n con el frontend React Native.

---

## üéØ Ejemplo Exitoso: Workers CRUD

### Referencia Completa Funcionando

Ver: `/docs/WORKERS_CRUD_EXAMPLE.md` para implementaci√≥n completa y probada.

**Estado**: ‚úÖ **TOTALMENTE FUNCIONAL**

-   API probada con todos los endpoints
-   Validaciones funcionando correctamente
-   Relaciones cargando apropiadamente
-   Filtros y paginaci√≥n operativos
-   Documentaci√≥n completa con ejemplos reales

### Comando Usado:

```bash
php artisan make:crud Admin/Worker
php artisan make:migration create_workers_table
php artisan migrate
```

### API Endpoints Probados:

-   ‚úÖ `POST /api/auth/admin/workers` - Crear (201 Created)
-   ‚úÖ `GET /api/auth/admin/workers` - Listar (200 OK)
-   ‚úÖ `GET /api/auth/admin/workers/{id}` - Ver (200 OK)
-   ‚úÖ `PUT /api/auth/admin/workers/{id}` - Actualizar
-   ‚úÖ `DELETE /api/auth/admin/workers/{id}` - Eliminar

**Este ejemplo debe ser la referencia para todos los CRUDs futuros.**
